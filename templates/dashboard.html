<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>UrbanPulse Scenario Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; max-width: 1100px; }
    .row { display: flex; gap: 16px; flex-wrap: wrap; }
    .card { border: 1px solid #ddd; border-radius: 14px; padding: 16px; flex: 1; min-width: 320px; }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid #333; cursor: pointer; }
    select { padding: 10px; border-radius: 10px; width: 100%; }
    pre { background: #111; color: #eee; padding: 12px; border-radius: 12px; overflow: auto; max-height: 420px; }
    .tag { display:inline-block; padding: 4px 10px; border-radius: 999px; border:1px solid #aaa; margin-left:8px; }
    .muted { color:#666; }
  </style>
</head>
<body>
  <h1>UrbanPulse <span class="tag">Scenario Mode</span></h1>
  <p class="muted">Run controlled haze scenarios to demonstrate agent coordination, decisions, and action logs.</p>

  <div class="row">
    <div class="card">
      <h3>Choose scenario</h3>
      <select id="scenario"></select>
      <div style="margin-top:12px; display:flex; gap:10px;">
        <button id="runBtn">Run Scenario</button>
        <button id="viewConfigBtn">View Config</button>
      </div>

      <p id="desc" style="margin-top:12px;"></p>
      <h4>PSI by region</h4>
      <pre id="psi"></pre>
    </div>

    <div class="card">
      <h3>Output</h3>
      <div id="summary" class="muted">No run yet.</div>
      <h4>Full JSON</h4>
      <pre id="result"></pre>
    </div>
  </div>

<script>
async function loadScenarios() {
  const res = await fetch("/api/scenarios");
  const data = await res.json();
  const sel = document.getElementById("scenario");
  sel.innerHTML = "";
  data.scenarios.forEach(s => {
    const opt = document.createElement("option");
    opt.value = s.key;
    opt.textContent = `${s.key} â€” ${s.description}`;
    opt.dataset.desc = s.description;
    opt.dataset.psi = JSON.stringify(s.psi_data, null, 2);
    sel.appendChild(opt);
  });
  sel.dispatchEvent(new Event("change"));
}

document.getElementById("scenario").addEventListener("change", (e) => {
  const opt = e.target.selectedOptions[0];
  document.getElementById("desc").textContent = opt.dataset.desc || "";
  document.getElementById("psi").textContent = opt.dataset.psi || "";
});

document.getElementById("viewConfigBtn").addEventListener("click", async () => {
  const res = await fetch("/config");
  const cfg = await res.json();
  document.getElementById("summary").innerHTML =
    `<p><b>DEMO_MODE:</b> ${cfg.DEMO_MODE}</p>
     <p><b>Instance:</b> ${cfg.instance.file} (pid ${cfg.instance.pid})</p>`;
});

document.getElementById("runBtn").addEventListener("click", async () => {
  const key = document.getElementById("scenario").value;
  document.getElementById("summary").textContent = "Running...";
  document.getElementById("result").textContent = "";

  const res = await fetch(`/api/run-scenario/${key}`, { method: "POST" });
  const out = await res.json();

  const risk = out?.risk_assessment?.risk_level || "UNKNOWN";
  const surge = out?.risk_assessment?.predicted_surge;
  const clinics = out?.healthcare_alerts?.total_clinics;

  document.getElementById("summary").innerHTML = `
    <p><b>Status:</b> ${out.status}</p>
    <p><b>Risk:</b> ${risk}</p>
    <p><b>Predicted Surge:</b> ${surge != null ? Math.round(surge*100) + "%" : "N/A"}</p>
    <p><b>Clinics Alerted:</b> ${clinics != null ? clinics : "N/A"}</p>
  `;

  document.getElementById("result").textContent = JSON.stringify(out, null, 2);
});

loadScenarios();
</script>
</body>
</html>
