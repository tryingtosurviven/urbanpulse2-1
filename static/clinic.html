<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>National Health Inventory | UrbanPulse</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    body { background: #f8fafc; font-family: 'Inter', sans-serif; margin: 0; padding: 0; color: #0f172a; padding-bottom: 120px; }

    /* Header & Grid */
    .header { background: white; padding: 15px 40px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 100; }
    .logo { font-size: 1.25rem; font-weight: 700; color: #334155; display: flex; align-items: center; gap: 10px; }
    .status-badge { background: #dcfce7; color: #166534; padding: 6px 16px; border-radius: 50px; font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 8px; border: 1px solid #bbf7d0; }
    .dot { height: 8px; width: 8px; background: #22c55e; border-radius: 50%; display: inline-block; }

    .container { max-width: 1400px; margin: 30px auto; padding: 0 30px; }
    .section-title { font-size: 1.1rem; font-weight: 700; color: #64748b; margin: 30px 0 15px 0; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 10px; }
    .section-title::after { content: ""; flex: 1; height: 1px; background: #e2e8f0; }

    .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
    .card { background: white; border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.02); transition: all 0.2s; cursor: pointer; position: relative; overflow: hidden; }
    .card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-color: #cbd5e1; }
    .region-tag { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: #94a3b8; margin-bottom: 8px; display: block; }
    .card h3 { margin: 0 0 15px 0; font-size: 1rem; color: #1e293b; height: 40px; display: flex; align-items: center; }
    .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; }
    .stat-label { color: #64748b; }
    .stat-val { font-weight: 600; color: #334155; }
    .stock-indicator { margin-top: 15px; padding: 6px 10px; background: #eff6ff; color: #1d4ed8; border-radius: 6px; font-size: 0.75rem; font-weight: 600; text-align: center; }

    /* MODAL STYLES */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(4px); }
    .modal { background: white; width: 500px; padding: 30px; border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); animation: popIn 0.2s ease-out; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #e2e8f0; }
    .modal-header h2 { margin: 0; font-size: 1.25rem; color: #0f172a; }
    .close-btn { background: none; border: none; font-size: 1.5rem; color: #94a3b8; cursor: pointer; }
    .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .detail-box { background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #f1f5f9; }
    .detail-box small { display: block; color: #64748b; font-size: 0.75rem; text-transform: uppercase; font-weight: 600; margin-bottom: 5px; }
    .detail-box strong { font-size: 1.1rem; color: #0f172a; }
    .logistics-btn { display: block; width: 100%; margin-top: 20px; background: #2563eb; color: white; padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; text-align: center; transition: background 0.2s; }
    .logistics-btn:hover { background: #1d4ed8; }

    /* SUCCESS PO MODAL */
    .po-modal { text-align: center; border: 4px solid transparent; transition: all 0.3s; }
    .po-icon { font-size: 3rem; margin-bottom: 15px; display: block; }
    .po-track-btn { background: #0f172a; color: white; padding: 12px 24px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; margin-top: 12px; display: inline-flex; align-items: center; gap: 8px; transition: background 0.3s; justify-content:center; width:100%; }
    .po-track-btn:hover { background: #334155; }

    /* DRAFT PANEL */
    #draft-panel {
      position: fixed; bottom: -200px; left: 0; width: 100%;
      background: white; border-top: 4px solid #f59e0b;
      box-shadow: 0 -10px 25px rgba(0,0,0,0.1);
      padding: 20px 0; z-index: 1500;
      transition: bottom 0.5s ease-out;
      display: flex; justify-content: center;
    }
    #draft-panel.visible { bottom: 0; }

    .draft-content {
      max-width: 1100px; width: 100%; display: flex;
      align-items: center; justify-content: space-between; gap: 30px;
    }
    .draft-info h3 { margin: 0 0 5px 0; color: #b45309; display: flex; align-items: center; gap: 10px; }
    .draft-facility { font-size: 0.9rem; color: #1e293b; font-weight: 600; margin-top: 4px; display: block; }

    .draft-action { display: flex; align-items: center; gap: 10px; }
    .qty-wrapper { display: flex; align-items: center; gap: 10px; background: #fffbeb; padding: 8px 15px; border-radius: 8px; border: 1px solid #fcd34d; margin-right: 10px; }
    .qty-input { width: 70px; padding: 8px; border: 1px solid #d97706; border-radius: 5px; font-weight: 700; font-size: 1.1rem; text-align: center; color: #b45309; }

    .approve-btn { background: #16a34a; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.95rem; display: flex; align-items: center; gap: 5px; }
    .approve-btn:hover { background: #15803d; }

    .reject-btn { background: white; color: #64748b; border: 1px solid #cbd5e1; padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.95rem; display: flex; align-items: center; gap: 5px; }
    .reject-btn:hover { background: #f1f5f9; color: #ef4444; border-color: #fca5a5; }

    /* ALERT STATE */
    .card.critical { border-left: 5px solid #ef4444; background: #fef2f2; }
    .card.critical .stock-indicator { background: #fee2e2; color: #991b1b; }
    .card.critical .stat-val { color: #b91c1c; }
    .status-badge.critical { background: #fee2e2; color: #991b1b; border-color: #fecaca; animation: pulse 2s infinite; }
    .status-badge.critical .dot { background: #ef4444; }

    /* AI Order Assistant */
    .ai-panel { max-width: 1400px; margin: 18px auto 0 auto; padding: 0 30px; }
    .ai-card {
      background: white; border: 1px solid #e2e8f0; border-radius: 14px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.02);
      padding: 18px 18px;
      display: grid; grid-template-columns: 1.2fr 1fr;
      gap: 18px; align-items: start;
    }
    .ai-title { font-weight: 800; color: #0f172a; display: flex; align-items: center; gap: 10px; margin: 0 0 6px 0; }
    .ai-sub { margin: 0 0 12px 0; color: #64748b; font-size: 0.92rem; line-height: 1.4; }
    .ai-buttons { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
    .ai-btn {
      border: 1px solid #cbd5e1; background: #f8fafc; color: #0f172a;
      padding: 10px 12px; border-radius: 10px; cursor: pointer;
      font-weight: 700; font-size: 0.9rem; transition: 0.2s;
    }
    .ai-btn:hover { transform: translateY(-1px); border-color: #94a3b8; }
    .ai-btn.low { border-left: 6px solid #10b981; }
    .ai-btn.mod { border-left: 6px solid #f59e0b; }
    .ai-btn.sev { border-left: 6px solid #ef4444; }

    /* Chat box */
    .chat-box {
      background: #0b1220; color: #e2e8f0; border-radius: 14px; padding: 14px;
      height: 160px; max-height: 160px;
      border: 1px solid rgba(148,163,184,0.25);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.9rem; line-height: 1.45;
      overflow-y: auto; overflow-x: hidden;
      white-space: pre-wrap; word-break: break-word;
    }
    .chat-line { margin: 0 0 8px 0; }
    .chat-label { color: #93c5fd; font-weight: 800; }

    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
    @keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    @media (max-width: 980px) { .ai-card { grid-template-columns: 1fr; } }
  </style>
</head>

<body>
  <div class="header">
    <a href="/" style="text-decoration:none; color:#334155; font-weight:700; margin-right:12px;">‚Üê Home</a>
    <div class="logo"><span style="font-size: 1.5rem;">üè•</span> Ministry of Health | Oversight</div>
    <div id="global-status" class="status-badge"><span class="dot"></span> System Normal</div>
  </div>

  <!-- AI Order Assistant -->
  <div class="ai-panel">
    <div class="ai-card">
      <div>
        <h3 class="ai-title">ü§ñ AI Order Assistant (Agentic Workflow)</h3>
        <p class="ai-sub">
          Choose a PSI severity scenario and UrbanPulse agents will recommend a mask order quantity.
          The output is generated server-side via agent orchestration (watsonx endpoint), then a Draft PO is created for review.
        </p>

        <div class="ai-buttons">
          <button class="ai-btn low" onclick="runClinicAssistant('low_haze')">üü¢ Low PSI</button>
          <button class="ai-btn mod" onclick="runClinicAssistant('moderate_haze')">üü† Moderate PSI</button>
          <button class="ai-btn sev" onclick="runClinicAssistant('severe_haze')">üî¥ Severe PSI</button>
          <button class="ai-btn" onclick="chatClear()">üßπ Clear</button>
        </div>
      </div>

      <div class="chat-box" id="assistant-chat">
        <div class="chat-line">
          <span class="chat-label">UrbanPulse:</span>
          Singapore Avg PSI (24-HR): <span id="sg-avg-psi">‚Äî</span>
          (<span id="sg-avg-status">‚Äî</span>). Select a scenario to analyze hospital-specific resupply needs.
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="section-title">Acute Hospitals Network</div>
    <div class="grid">
      <div class="card" onclick="openModal('ttsh')"><span class="region-tag">Central</span><h3>Tan Tock Seng Hospital</h3><div class="stat-row"><span class="stat-label">N95 Stock:</span><span class="stat-val" id="ttsh-stock">1,200</span></div><div class="stock-indicator" id="ttsh-status">Supply Healthy</div></div>
      <div class="card" onclick="openModal('nuh')"><span class="region-tag">West</span><h3>National University Hosp.</h3><div class="stat-row"><span class="stat-label">N95 Stock:</span><span class="stat-val" id="nuh-stock">950</span></div><div class="stock-indicator" id="nuh-status">Supply Healthy</div></div>
      <div class="card" onclick="openModal('cgh')"><span class="region-tag">East</span><h3>Changi General Hosp.</h3><div class="stat-row"><span class="stat-label">N95 Stock:</span><span class="stat-val" id="cgh-stock">1,050</span></div><div class="stock-indicator" id="cgh-status">Supply Healthy</div></div>
      <div class="card" onclick="openModal('ktph')"><span class="region-tag">North</span><h3>Khoo Teck Puat Hosp.</h3><div class="stat-row"><span class="stat-label">N95 Stock:</span><span class="stat-val" id="ktph-stock">890</span></div><div class="stock-indicator" id="ktph-status">Supply Healthy</div></div>
    </div>

    <div class="section-title">Polyclinic Network (Primary Care)</div>
    <div class="grid">
      <div class="card" onclick="openModal('amk')"><span class="region-tag">Central</span><h3>Ang Mo Kio Polyclinic</h3><div class="stat-row"><span class="stat-label">Mask Stock:</span><span class="stat-val" id="amk-stock">5,000</span></div><div class="stock-indicator" id="amk-status">Supply Healthy</div></div>
      <div class="card" onclick="openModal('jurong')"><span class="region-tag">West</span><h3>Jurong Polyclinic</h3><div class="stat-row"><span class="stat-label">Mask Stock:</span><span class="stat-val" id="jurong-stock">4,200</span></div><div class="stock-indicator" id="jurong-status">Supply Healthy</div></div>
      <div class="card" onclick="openModal('tamp')"><span class="region-tag">East</span><h3>Tampines Polyclinic</h3><div class="stat-row"><span class="stat-label">Mask Stock:</span><span class="stat-val" id="tamp-stock">4,800</span></div><div class="stock-indicator" id="tamp-status">Supply Healthy</div></div>
      <div class="card" onclick="openModal('woodlands')"><span class="region-tag">North</span><h3>Woodlands Polyclinic</h3><div class="stat-row"><span class="stat-label">Mask Stock:</span><span class="stat-val" id="woodlands-stock">3,900</span></div><div class="stock-indicator" id="woodlands-status">Supply Healthy</div></div>
    </div>
  </div>

  <!-- Draft Panel -->
  <div id="draft-panel">
    <div class="draft-content">
      <div class="draft-info">
        <h3>‚ö†Ô∏è ACTION REQUIRED: Draft PO Generated</h3>
        <span id="draft-facility" class="draft-facility">---</span>
        <div style="font-size:0.8rem; color:#999; margin-top:2px;">PO ID: <span id="draft-id">---</span></div>
      </div>
      <div class="draft-action">
        <div class="qty-wrapper">
          <span style="font-weight:600; color:#b45309;">Rec. Qty:</span>
          <input type="number" id="draft-qty" class="qty-input" value="0">
          <span style="font-size:0.9rem; color:#b45309;">Units</span>
        </div>
        <button onclick="rejectDraft()" class="reject-btn">‚ùå Reject</button>
        <button onclick="approveDraft()" class="approve-btn">‚úÖ Approve & Order</button>
      </div>
    </div>
  </div>

  <!-- Detail modal -->
  <div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
    <div class="modal">
      <div class="modal-header">
        <h2 id="modal-title">Details</h2>
        <button class="close-btn" onclick="document.getElementById('modal-overlay').style.display='none'">&times;</button>
      </div>
      <div class="detail-grid">
        <div class="detail-box"><small>Status</small><strong id="modal-surge">Normal</strong></div>
        <div class="detail-box"><small>Stock</small><strong id="modal-stock">---</strong></div>
        <div class="detail-box"><small>Staff</small><strong id="modal-staff">---</strong></div>
        <div class="detail-box"><small>Wait</small><strong id="modal-wait">---</strong></div>
      </div>
      <button class="logistics-btn">üöö Track Incoming Supplies</button>
      <div style="margin-top:15px; font-size:0.85rem; color:#64748b; background:#f1f5f9; padding:10px; border-radius:6px;">
        üì° <strong>Live Agent Feed:</strong> Data synchronized with National Stockpile Sentinel Agent.
      </div>
    </div>
  </div>

  <!-- Success modal -->
  <div class="modal-overlay" id="success-overlay" style="display:none;">
    <div class="modal po-modal">
      <span class="po-icon">‚úÖ</span>
      <h2 style="margin:0 0 10px 0; color:#166534">Order Confirmed</h2>
      <p style="color:#64748b; margin-bottom:20px;">Official PO has been generated and dispatched.</p>

      <div style="background:#f8fafc; padding:15px; border-radius:8px; border:1px solid #e2e8f0; text-align:left; margin-bottom:12px;">
        <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>Facility:</span><strong>Tan Tock Seng Hospital</strong></div>
        <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>Quantity:</span><strong id="confirmed-qty-disp">---</strong></div>
        <div style="display:flex; justify-content:space-between;"><span>Status:</span><strong style="color:#0ea5e9">Dispatched</strong></div>
      </div>

      <button id="track-logistics-btn" class="po-track-btn">üöö Track on Logistics Map</button>
      <button id="po-close-btn" onclick="document.getElementById('success-overlay').style.display='none'" style="margin-top:10px; background:none; border:none; color:#64748b; cursor:pointer;">Close</button>
    </div>
  </div>

  <!-- Unified frontend controller -->
  <script src="/static/script.js"></script>

  <script>
    /* Facility modal logic */
    const facilityData = {
      'ttsh': { name: "Tan Tock Seng Hospital", stock: "1,200", staff: "342", wait: "1.5 Hrs", surge: "Normal" },
      'nuh': { name: "National University Hosp.", stock: "950", staff: "289", wait: "2.0 Hrs", surge: "Normal" },
      'cgh': { name: "Changi General Hosp.", stock: "1,050", staff: "310", wait: "1.2 Hrs", surge: "Normal" },
      'ktph': { name: "Khoo Teck Puat Hosp.", stock: "890", staff: "250", wait: "1.8 Hrs", surge: "Normal" },
      'amk': { name: "Ang Mo Kio Polyclinic", stock: "5,000", staff: "45", wait: "30 Mins", surge: "Normal" },
      'jurong': { name: "Jurong Polyclinic", stock: "4,200", staff: "38", wait: "45 Mins", surge: "Normal" },
      'tamp': { name: "Tampines Polyclinic", stock: "4,800", staff: "42", wait: "25 Mins", surge: "Normal" },
      'woodlands': { name: "Woodlands Polyclinic", stock: "3,900", staff: "40", wait: "60 Mins", surge: "Busy" }
    };

    function openModal(id) {
      const data = facilityData[id];
      document.getElementById('modal-title').innerText = data.name;
      document.getElementById('modal-stock').innerText = data.stock;
      document.getElementById('modal-staff').innerText = data.staff;
      document.getElementById('modal-wait').innerText = data.wait;

      const surgeElem = document.getElementById('modal-surge');
      surgeElem.innerText = data.surge;
      surgeElem.style.color = data.surge.includes('CRITICAL') ? '#dc2626' : '#166534';

      document.querySelector('.logistics-btn').onclick = function() {
        window.location.href = '/logistics?id=' + id;
      };

      document.getElementById('modal-overlay').style.display = 'flex';
    }
    function closeModal(e) { if (e.target.id === 'modal-overlay') e.target.style.display = 'none'; }

    /* Polling & Remote Control */
    let userDraftVisible = false;
    let suppressDraftPopupUntil = 0;

    function deactivateAlertMode() {
      const badge = document.getElementById('global-status');
      badge.className = 'status-badge';
      badge.style.background = '';
      badge.style.color = '';
      badge.style.borderColor = '';
      badge.innerHTML = '<span class="dot"></span> System Normal';
      document.querySelectorAll('.card').forEach(card => card.classList.remove('critical'));
    }

    setInterval(async () => {
      try {
        const res = await fetch('/api/clinic-poll');
        const data = await res.json();

        const psi = Number(data.psi || 0);
        const protocol = (data.protocol || "").toLowerCase();
        const isSevere = protocol === "autonomous" || psi >= 200;

        if (isSevere) activateAlertMode();
        else deactivateAlertMode();

        if (protocol === 'autonomous' && data.draft && data.draft.active) {
          activateAutonomousMode();
          executeAutoOrder(data.draft.qty);
        }

        if (data.current_view === 'logistics') {
          window.location.href = '/logistics';
        }

        if (
          Date.now() > suppressDraftPopupUntil &&
          !userDraftVisible &&
          data.draft &&
          data.draft.active &&
          protocol !== 'autonomous'
        ) {
          showDraftPanel(data.draft);
        }

      } catch (e) { console.error("Polling error:", e); }
    }, 2000);

    let isAutoOrdering = false;

    function setLogisticsButtonLink({ id = "ttsh", qty = 0 } = {}) {
      const btn = document.getElementById("track-logistics-btn");
      if (!btn) return;
      btn.onclick = () => {
        window.location.href = `/logistics?id=${encodeURIComponent(id)}&qty=${encodeURIComponent(qty)}`;
      };
    }

    async function executeAutoOrder(qty) {
      if (isAutoOrdering) return;
      isAutoOrdering = true;

      await fetch('/api/clinic-confirm-order', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ confirmed_qty: qty })
      });

      document.getElementById('confirmed-qty-disp').innerText = qty + " Units (N95)";

      const modal = document.querySelector('.po-modal');
      modal.style.border = "4px solid #a855f7";
      document.querySelector('.po-icon').innerText = "‚ö°";
      document.querySelector('.po-modal h2').innerText = "AI Auto-Dispatch";
      document.querySelector('.po-modal h2').style.color = "#7e22ce";

      setLogisticsButtonLink({ id: "ttsh", qty });
      document.getElementById('success-overlay').style.display = 'flex';

      const poParagraph = document.querySelector('.po-modal p');
      if (poParagraph) poParagraph.innerText = 'Official PO has been generated and dispatched. You will be redirected to tracking shortly.';

      const closeBtn = document.getElementById('po-close-btn');
      if (closeBtn) closeBtn.style.display = 'none';

      setTimeout(() => {
        window.location.href = '/logistics?id=ttsh&qty=' + qty;
      }, 3000);

      setTimeout(() => { isAutoOrdering = false; }, 5000);
    }

    function showDraftPanel(draft) {
      const panel = document.getElementById('draft-panel');
      document.getElementById('draft-id').innerText = draft.id;
      document.getElementById('draft-facility').innerText = "üìç For: " + (draft.facility || "Tan Tock Seng Hospital");
      document.getElementById('draft-qty').value = draft.qty;

      panel.classList.add('visible');
      userDraftVisible = true;
    }

    async function approveDraft() {
      const newQty = document.getElementById('draft-qty').value;

      await fetch('/api/clinic-confirm-order', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ confirmed_qty: newQty })
      });

      document.getElementById('draft-panel').classList.remove('visible');
      suppressDraftPopupUntil = Date.now() + 8000;
      userDraftVisible = true;

      document.getElementById('confirmed-qty-disp').innerText = newQty + " Units (N95)";

      const modal = document.querySelector('.po-modal');
      modal.style.border = "none";
      document.querySelector('.po-icon').innerText = "‚úÖ";
      document.querySelector('.po-modal h2').innerText = "Order Confirmed";
      document.querySelector('.po-modal h2').style.color = "#166534";

      setLogisticsButtonLink({ id: "ttsh", qty: newQty });
      document.getElementById('success-overlay').style.display = 'flex';

      const poParagraph = document.querySelector('.po-modal p');
      if (poParagraph) poParagraph.innerText = 'Official PO has been generated and dispatched.';

      const closeBtn = document.getElementById('po-close-btn');
      if (closeBtn) closeBtn.style.display = 'inline-block';
    }

    async function rejectDraft() {
      await fetch('/api/clinic-reject-order', { method: 'POST' });
      document.getElementById('draft-panel').classList.remove('visible');
      userDraftVisible = false;
    }

    function activateAlertMode() {
      const badge = document.getElementById('global-status');
      badge.className = 'status-badge critical';
      badge.innerHTML = '<span class="dot"></span> ‚ö†Ô∏è HAZE EMERGENCY';
      document.querySelectorAll('.card').forEach(card => card.classList.add('critical'));
    }

    function activateAutonomousMode() {
      const badge = document.getElementById('global-status');
      badge.style.background = '#7e22ce';
      badge.style.color = '#ffffff';
      badge.style.borderColor = '#a855f7';
      badge.innerHTML = '‚ö° AI AUTONOMOUS PROTOCOL';
    }

    /* Chat actions */
    let assistantIsRunning = false;
    let lastStatusEl = null;

    function getChatBox() { return document.getElementById('assistant-chat'); }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function chatAdd(text, opts = {}) {
      const box = getChatBox();
      if (!box) return;

      const line = document.createElement('div');
      line.className = "chat-line";
      line.innerHTML = `<span class="chat-label">UrbanPulse:</span> ${escapeHtml(text)}`;

      if (opts.status) {
        if (lastStatusEl && lastStatusEl.parentNode === box) {
          lastStatusEl.innerHTML = line.innerHTML;
          lastStatusEl.className = line.className;
          box.scrollTop = box.scrollHeight;
          return;
        }
        lastStatusEl = line;
      }

      box.appendChild(line);

      const maxLines = 10;
      while (box.children.length > maxLines) box.removeChild(box.firstElementChild);

      box.scrollTop = box.scrollHeight;
    }

    function chatClear() {
      const box = getChatBox();
      if (!box) return;
      box.innerHTML = '';
      lastStatusEl = null;

      const line = document.createElement('div');
      line.className = "chat-line";
      line.innerHTML = `
        <span class="chat-label">UrbanPulse:</span>
        Singapore Avg PSI (24-HR): <span id="sg-avg-psi">‚Äî</span>
        (<span id="sg-avg-status">‚Äî</span>). Select a scenario to analyze hospital-specific resupply needs.
      `;
      box.appendChild(line);
    }

    function setScenarioButtonsEnabled(enabled) {
      document.querySelectorAll('.ai-btn').forEach(btn => {
        btn.disabled = !enabled;
        btn.style.opacity = enabled ? "1" : "0.6";
        btn.style.cursor = enabled ? "pointer" : "not-allowed";
      });
    }

    function extractRecommendedQty(result, scenarioKey) {
      const supply = result?.supply_chain_actions || result?.supply || result?.procurement || {};
      const direct = supply.recommended_qty ?? supply.qty ?? supply.recommended ?? result?.recommended_qty ?? result?.qty;
      const parsed = parseInt(direct, 10);
      if (!Number.isNaN(parsed) && parsed > 0) return parsed;

      if (scenarioKey === 'severe_haze') return 1200;
      if (scenarioKey === 'moderate_haze') return 600;
      return 250;
    }

    function psiCategory(psi) {
      if (psi <= 50) return "Good";
      if (psi <= 100) return "Moderate";
      if (psi <= 200) return "Unhealthy";
      if (psi <= 300) return "Very Unhealthy";
      return "Hazardous";
    }

    /* Predictive burn-rate mapping */
    function predictBurnRateHours(psi, scenarioKey) {
      const p = Number(psi);
      if (Number.isFinite(p)) {
        if (p >= 200) return 4;
        if (p >= 101) return 14;
        return 72;
      }
      if (scenarioKey === 'severe_haze') return 4;
      if (scenarioKey === 'moderate_haze') return 14;
      return 72;
    }

    function extractPsiDict(result) {
      const raw = result?.raw_data || result?.data || {};
      return (
        result?.environmental_data?.psi_by_region ||
        raw?.psi_data ||
        result?.psi_data ||
        {}
      );
    }

    function computeAvgPsi(psiDict) {
      if (!psiDict || typeof psiDict !== "object") return null;
      const vals = Object.values(psiDict).map(v => Number(v)).filter(v => Number.isFinite(v));
      if (!vals.length) return null;
      return Math.round(vals.reduce((a, b) => a + b, 0) / vals.length);
    }

    function setFakeSingaporeAvgPsi() {
      const fakePsi = 68; // demo fallback
      const status = psiCategory(fakePsi);
      const psiEl = document.getElementById("sg-avg-psi");
      const statusEl = document.getElementById("sg-avg-status");
      if (psiEl) psiEl.innerText = String(fakePsi);
      if (statusEl) statusEl.innerText = status;
    }

    function updateSingaporeAvgPsi(result) {
      const psiDict = extractPsiDict(result);
      const avg = computeAvgPsi(psiDict);
      if (avg == null) {
        setFakeSingaporeAvgPsi();
        return;
      }
      const status = psiCategory(avg);
      const psiEl = document.getElementById("sg-avg-psi");
      const statusEl = document.getElementById("sg-avg-status");
      if (psiEl) psiEl.innerText = String(avg);
      if (statusEl) statusEl.innerText = status;
    }

    async function runClinicAssistant(scenarioKey) {
      if (assistantIsRunning) return;
      assistantIsRunning = true;
      setScenarioButtonsEnabled(false);

      chatAdd(`Running agent workflow for scenario: ${scenarioKey}...`, { status: true });

      try {
        const res = await fetch(`/api/run-scenario/${encodeURIComponent(scenarioKey)}?source=ui`, {
          method: "POST",
          headers: { "Content-Type": "application/json" }
        });
        const result = await res.json();
        
        updateSingaporeAvgPsi(result);

        const risk = result?.risk_assessment || {};
        const riskLevel = risk.risk_level || result?.risk_level || "N/A";
        const highestPsi = risk.current_psi || result?.current_psi || result?.psi || "N/A";

        const qty = extractRecommendedQty(result, scenarioKey);

        const burnRateFromApi =
          result?.predictive_analytics?.burn_rate_hours ??
          result?.burn_rate_hours;

        const burnHours = Number.isFinite(Number(burnRateFromApi))
          ? Number(burnRateFromApi)
          : predictBurnRateHours(highestPsi, scenarioKey);
        
        const forecast = result?.predictive_analytics;
        if (forecast?.predicted_psi) {
          chatAdd(
            `Forecast Agent: In ~${forecast.horizon_hours} hrs, PSI may rise to ${forecast.predicted_psi} (${forecast.predicted_risk_level}). Confidence ${(forecast.confidence*100).toFixed(0)}%.`,
            { status: false }
          );
        }

        chatAdd(
          `Assessment: PSI ${highestPsi} ‚Üí ${riskLevel}. Predicted burn rate: current stock lasts ~${burnHours} hours. Recommended N95 order quantity: ${qty}.`,
          { status: true }
        );

        const supply = result?.supply_chain_actions;
        if (supply?.po_id) chatAdd(`Draft created: ${supply.po_id}`);

        if (String(supply?.autonomous || "").toLowerCase() !== "true") {}

      } catch (e) {
        chatAdd(`Error: ${e.message || e}`, { status: true });
      } finally {
        assistantIsRunning = false;
        setScenarioButtonsEnabled(true);
      }
    }
  </script>

  <script>
    window.watsonAssistantChatOptions = {
      integrationID: "16b93be7-5249-4f25-a201-3584e0152718",
      region: "aws-ap-southeast-1",
      serviceInstanceID: "20260127-1515-5797-5009-cb9a48045b0d",
      orchestrateUIAgentExtensions: false,
      onLoad: async (instance) => { await instance.render(); }
    };
    setTimeout(function(){
      const t=document.createElement('script');
      t.src="https://web-chat.global.assistant.watson.appdomain.cloud/versions/" + (window.watsonAssistantChatOptions.clientVersion || 'latest') + "/WatsonAssistantChatEntry.js";
      document.head.appendChild(t);
    });

    // initial fallback PSI for demo
    setFakeSingaporeAvgPsi();
  </script>

</body>
</html>
