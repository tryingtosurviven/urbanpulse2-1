<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Supply Chain Logistics | UrbanPulse</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; display: flex; height: 100vh; font-family: 'Inter', sans-serif; }
        
        /* Sidebar */
        .sidebar { width: 350px; background: white; padding: 30px; box-shadow: 2px 0 10px rgba(0,0,0,0.1); z-index: 1000; display: flex; flex-direction: column; }
        .back-link { color: #3b82f6; text-decoration: none; font-weight: 600; margin-bottom: 20px; display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .back-link:hover { text-decoration: underline; }
        
        h1 { margin: 0 0 10px 0; color: #1e293b; font-size: 1.8rem; }
        .subtitle { color: #64748b; margin-bottom: 30px; }

        /* Truck Status Card */
        .status-card { background: #f0f9ff; border-left: 5px solid #0ea5e9; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .status-card h3 { margin: 0 0 5px 0; color: #0c4a6e; }
        .status-row { display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.9rem; }
        
        /* Map Area */
        #map { flex: 1; height: 100%; z-index: 1; }
        
        /* Custom Marker */
        .truck-icon { font-size: 24px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); animation: bounce 1s infinite alternate; }
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-5px); } }
    </style>
</head>
<body>

    <div class="sidebar">
        <a onclick="window.location.href='/clinic'" class="back-link">‚Üê Back to Clinic Portal</a>
        
        <h1>Supply Logistics</h1>
        <p class="subtitle">AI-Orchestrated resupply in progress.</p>
        
        <div class="status-card">
            <h3 id="truck-title">N95 Resupply Truck #04</h3>
            <div style="font-size: 0.9rem; color: #555; margin-bottom: 15px;" id="dest-name">
                En Route to: Tan Tock Seng Hospital
            </div>
            <div class="status-row">
                <strong>Status:</strong> <span style="color:#0ea5e9">In Transit</span>
            </div>
            <div class="status-row">
                <strong>ETA:</strong> <strong id="eta-timer">12 Minutes</strong>
            </div>
            <div class="status-row">
                <strong>Cargo:</strong> <span>5,000 N95 Masks</span>
            </div>
        </div>

        <div style="margin-top: auto; font-size: 0.8rem; color: #94a3b8;">
            <p><strong>Route Optimization:</strong> Active</p>
            <p><strong>Traffic Avoidance:</strong> Enabled</p>
            <p><strong>AI Confidence:</strong> 98.4%</p>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- 1. COORDINATE DATABASE ---
        const locations = {
            'ttsh': { name: "Tan Tock Seng Hospital", lat: 1.321, lng: 103.845 },
            'nuh':  { name: "National University Hosp.", lat: 1.294, lng: 103.783 },
            'cgh':  { name: "Changi General Hospital", lat: 1.340, lng: 103.963 },
            'ktph': { name: "Khoo Teck Puat Hospital", lat: 1.424, lng: 103.838 },
            'amk':  { name: "Ang Mo Kio Polyclinic", lat: 1.374, lng: 103.845 },
            'jurong': { name: "Jurong Polyclinic", lat: 1.349, lng: 103.743 },
            'tamp':   { name: "Tampines Polyclinic", lat: 1.355, lng: 103.944 },
            'woodlands': { name: "Woodlands Polyclinic", lat: 1.442, lng: 103.770 }
        };

        // --- 2. GET URL PARAMETERS (ID and QTY) ---
        const urlParams = new URLSearchParams(window.location.search);
        const facilityId = urlParams.get('id') || 'ttsh'; 
        const qty = urlParams.get('qty') || '5,000'; // Default to 5,000 if no specific order
        
        const target = locations[facilityId] || locations['ttsh'];

        // Update Sidebar Text
        document.getElementById('truck-title').innerText = "N95 Resupply Truck #04";
        document.getElementById('dest-name').innerText = "En Route to: " + target.name;
        
        // --- NEW: Update Sidebar Cargo ---
        // You need to find the element containing "Cargo:" text
        // Let's find the specific 'span' inside the status card
        const statusRows = document.querySelectorAll('.status-row');
        // The 3rd row (index 2) is Cargo
        if(statusRows[2]) {
            const cargoSpan = statusRows[2].querySelector('span');
            if(cargoSpan) cargoSpan.innerText = qty + " N95 Masks";
        }

        // --- 3. INITIALIZE MAP ---
        var map = L.map('map').setView([target.lat, target.lng], 13);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '¬© OpenStreetMap contributors & CARTO',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        // --- 4. ADD MARKERS ---
        // Destination Marker
        var hospitalIcon = L.divIcon({
            html: '<div style="font-size:30px;">üè•</div>',
            className: 'dummy',
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });
        
        L.marker([target.lat, target.lng], {icon: hospitalIcon})
            .addTo(map)
            .bindPopup(`<b>${target.name}</b><br>Resupply Destination`)
            .openPopup();

        // Truck Marker
        var startLat = target.lat - 0.02; 
        var startLng = target.lng - 0.02;

        var truckIcon = L.divIcon({
            html: '<div class="truck-icon">üöõ</div>',
            className: 'dummy',
            iconSize: [40, 40],
            iconAnchor: [20, 20]
        });

        var truckMarker = L.marker([startLat, startLng], {icon: truckIcon}).addTo(map);
        
        // --- NEW: DYNAMIC TOOLTIP ---
        truckMarker.bindTooltip(`Truck #04<br>Cargo: ${qty} Units`, {permanent: true, direction: 'right', offset: [10, 0]});

        // --- 5. ANIMATE TRUCK ---
        let step = 0;
        const totalSteps = 200; 
        
        function animateTruck() {
            step++;
            if (step > totalSteps) step = 0; 
            
            const currentLat = startLat + ((target.lat - startLat) * (step / totalSteps));
            const currentLng = startLng + ((target.lng - startLng) * (step / totalSteps));
            
            truckMarker.setLatLng([currentLat, currentLng]);
            requestAnimationFrame(animateTruck);
        }
        animateTruck();

        // ETA Timer
        let eta = 12;
        setInterval(() => {
            if (eta > 0) {
                eta--;
                document.getElementById('eta-timer').innerText = eta + " Minutes";
            }
        }, 60000); 
    </script>
</body>
</html>
