<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Supply Chain Logistics | UrbanPulse</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; display: flex; height: 100vh; font-family: 'Inter', sans-serif; }
        
        /* Sidebar */
        .sidebar { width: 380px; background: white; padding: 30px; box-shadow: 2px 0 10px rgba(0,0,0,0.1); z-index: 1000; display: flex; flex-direction: column; overflow-y: auto; }
        .back-link { color: #3b82f6; text-decoration: none; font-weight: 600; margin-bottom: 20px; display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .back-link:hover { text-decoration: underline; }
        
        h1 { margin: 0 0 10px 0; color: #1e293b; font-size: 1.8rem; }
        .subtitle { color: #64748b; margin-bottom: 25px; border-bottom: 1px solid #e2e8f0; padding-bottom: 15px; }

        /* DYNAMIC TRUCK CARDS */
        .status-card { 
            background: white; border: 1px solid #e2e8f0; border-left: 5px solid #cbd5e1; 
            padding: 20px; border-radius: 8px; margin-bottom: 15px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: all 0.2s; cursor: pointer; position: relative;
        }
        
        /* Hover Effect */
        .status-card:hover { transform: translateY(-2px); box-shadow: 0 5px 10px rgba(0,0,0,0.1); }

        /* Selected / Active Style */
        .status-card.active-focus { 
            background: #f0f9ff; border-left-color: #0ea5e9; 
            border-color: #bae6fd; box-shadow: 0 8px 15px -3px rgba(14, 165, 233, 0.15); 
        }
        
        .status-card h3 { margin: 0 0 5px 0; color: #0f172a; display: flex; justify-content: space-between; align-items: center; font-size: 1.1rem; }
        .status-badge { background: #94a3b8; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; }
        .status-card.active-focus .status-badge { background: #0ea5e9; animation: pulse 2s infinite; }
        
        .status-row { display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.9rem; }
        .card-label { color: #64748b; font-size: 0.85rem; }
        
        /* DELETE BUTTON */
        .delete-btn {
            position: absolute; top: 10px; right: 10px;
            background: none; border: none; color: #cbd5e1;
            font-size: 1.2rem; cursor: pointer; padding: 0; line-height: 1;
            transition: color 0.2s; z-index: 10;
        }
        .delete-btn:hover { color: #ef4444; }

        /* History Log */
        .history-section { margin-top: 30px; border-top: 1px solid #e2e8f0; padding-top: 20px; }
        .history-section h4 { color: #94a3b8; font-size: 0.8rem; text-transform: uppercase; margin-bottom: 15px; letter-spacing: 0.5px; }
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; font-size: 0.85rem; color: #94a3b8; border-bottom: 1px solid #f8fafc; }

        #map { flex: 1; height: 100%; z-index: 1; }
        .truck-icon { font-size: 35px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); animation: bounce 1s infinite alternate; }
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-5px); } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div class="sidebar">
        <a onclick="window.location.href='/clinic'" class="back-link">‚Üê Back to Clinic Portal</a>
        
        <h1>Supply Logistics</h1>
        <p class="subtitle">Live Resupply Operations</p>
        
        <div id="truck-list-container">
            </div>

        <div class="history-section">
            <h4>Deliveries This Week (Completed)</h4>
            <div id="history-list"></div>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- 1. COORDINATE DATABASE ---
        const locations = {
            'ttsh': { name: "Tan Tock Seng Hospital", lat: 1.321, lng: 103.845 },
            'nuh':  { name: "National University Hosp.", lat: 1.294, lng: 103.783 },
            'cgh':  { name: "Changi General Hospital", lat: 1.340, lng: 103.963 },
            'ktph': { name: "Khoo Teck Puat Hospital", lat: 1.424, lng: 103.838 },
            'amk':  { name: "Ang Mo Kio Polyclinic", lat: 1.374, lng: 103.845 },
            'jurong': { name: "Jurong Polyclinic", lat: 1.349, lng: 103.743 },
            'tamp':   { name: "Tampines Polyclinic", lat: 1.355, lng: 103.944 },
            'woodlands': { name: "Woodlands Polyclinic", lat: 1.442, lng: 103.770 }
        };

        const urlParams = new URLSearchParams(window.location.search);
        const facilityId = urlParams.get('id') || 'ttsh'; 
        const newOrderQty = urlParams.get('qty'); 
        const target = locations[facilityId] || locations['ttsh'];

        // --- 2. STORAGE & INITIALIZATION ---
        const storageKey = 'trucks_' + facilityId;
        let activeTrucks = JSON.parse(localStorage.getItem(storageKey) || '[]');

        // Initialize empty list if needed
        if (activeTrucks.length === 0) {
            activeTrucks.push({
                idNum: 4, name: "Truck #04", qty: "5,000",
                destination: target.name, timestamp: Date.now()
            });
            localStorage.setItem(storageKey, JSON.stringify(activeTrucks));
        }

        // Add New Order if Qty present and different
        if (newOrderQty) {
            const lastTruck = activeTrucks[0];
            if (!lastTruck || lastTruck.qty !== newOrderQty) {
                const nextId = (activeTrucks.length > 0) ? (activeTrucks[0].idNum + 1) : 5;
                const newTruck = {
                    idNum: nextId,
                    name: "Truck #0" + nextId,
                    qty: newOrderQty,
                    destination: target.name,
                    timestamp: Date.now()
                };
                activeTrucks.unshift(newTruck); 
                localStorage.setItem(storageKey, JSON.stringify(activeTrucks));
            }
        }

        // Selected Truck Index (Defaults to 0 / Top)
        let selectedTruckIndex = 0; 

        // --- 3. RENDER FUNCTION (Handles Display & Clicks) ---
        function renderTrucks() {
            const container = document.getElementById('truck-list-container');
            container.innerHTML = "";

            if (activeTrucks.length === 0) {
                container.innerHTML = "<div style='color:#999; font-style:italic;'>No active shipments.</div>";
                return;
            }

            activeTrucks.forEach((truck, index) => {
                const isSelected = (index === selectedTruckIndex);
                const card = document.createElement('div');
                
                // Style based on selection
                card.className = isSelected ? 'status-card active-focus' : 'status-card';
                
                const badgeText = isSelected ? 'LIVE TRACKING' : 'EN ROUTE';
                const statusColor = isSelected ? '#0ea5e9' : '#64748b';
                const statusText = isSelected ? '‚ö° Entering Last Mile' : 'üöõ In Transit';
                const eta = isSelected ? "~ 12 Minutes" : "~ 45 Minutes"; 

                // HTML Content with Delete Button
                card.innerHTML = `
                    <button class="delete-btn" onclick="deleteTruck(event, ${index})">&times;</button>
                    <h3>
                        <span>${truck.name}</span> <span class="status-badge">${badgeText}</span>
                    </h3>
                    <div style="font-size: 0.85rem; color: #555; margin-bottom: 15px;">
                        En Route to: ${target.name}
                    </div>
                    <div class="status-row">
                        <span class="card-label">Status:</span> <strong style="color:${statusColor};">${statusText}</strong>
                    </div>
                    <div class="status-row">
                        <span class="card-label">ETA:</span> <strong style="color:#d97706">${eta}</strong>
                    </div>
                    <div class="status-row">
                        <span class="card-label">Payload:</span> <strong style="color:#0f172a">${truck.qty} Units (N95)</strong>
                    </div>
                `;
                
                // Click to Select Logic
                card.onclick = () => selectTruck(index);
                
                container.appendChild(card);
            });
            
            updateMapTooltip();
        }

        // --- 4. ACTION FUNCTIONS ---

        // Select a Truck
        function selectTruck(index) {
            selectedTruckIndex = index;
            renderTrucks(); // Re-render to update highlighting
        }

        // Delete a Truck
        window.deleteTruck = function(event, index) {
            event.stopPropagation(); // Prevent triggering the "Select" click
            
            if (confirm("Cancel this shipment?")) {
                activeTrucks.splice(index, 1);
                localStorage.setItem(storageKey, JSON.stringify(activeTrucks));
                
                // Adjust selection if needed
                if (selectedTruckIndex >= activeTrucks.length) {
                    selectedTruckIndex = Math.max(0, activeTrucks.length - 1);
                }
                
                renderTrucks();
            }
        };

        // --- 5. MAP SETUP ---
        var map = L.map('map').setView([target.lat, target.lng], 13);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '¬© OpenStreetMap contributors & CARTO', subdomains: 'abcd', maxZoom: 19
        }).addTo(map);

        var hospitalIcon = L.divIcon({ html: '<div style="font-size:30px;">üè•</div>', className: 'dummy', iconSize: [30, 30], iconAnchor: [15, 15] });
        L.marker([target.lat, target.lng], {icon: hospitalIcon}).addTo(map).bindPopup(`<b>${target.name}</b>`).openPopup();

        var startLat = target.lat - 0.02; var startLng = target.lng - 0.02;
        var truckIcon = L.divIcon({ html: '<div class="truck-icon">üöõ</div>', className: 'dummy', iconSize: [40, 40], iconAnchor: [20, 20] });
        var truckMarker = L.marker([startLat, startLng], {icon: truckIcon}).addTo(map);
        
        // --- 6. DYNAMIC MAP UPDATER ---
        function updateMapTooltip() {
            if (activeTrucks.length > 0) {
                const currentTruck = activeTrucks[selectedTruckIndex];
                // Unbind old tooltip and bind new one to ensure text updates
                truckMarker.unbindTooltip(); 
                truckMarker.bindTooltip(`${currentTruck.name}<br>Cargo: ${currentTruck.qty}`, {permanent: true, direction: 'right', offset: [10, 0]});
                truckMarker.setOpacity(1);
            } else {
                truckMarker.setOpacity(0); // Hide truck if no orders
            }
        }

        // --- 7. ANIMATION ---
        let step = 0; const totalSteps = 400; 
        function animateTruck() {
            step++; if (step > totalSteps) step = 0; 
            const currentLat = startLat + ((target.lat - startLat) * (step / totalSteps));
            const currentLng = startLng + ((target.lng - startLng) * (step / totalSteps));
            truckMarker.setLatLng([currentLat, currentLng]);
            requestAnimationFrame(animateTruck);
        }
        animateTruck();

        // --- 8. INITIAL HISTORY RENDER ---
        const historyContainer = document.getElementById('history-list');
        historyContainer.innerHTML = `
            <div class="history-item">
                <div><strong>Truck #03 (${target.name})</strong><div style="font-size:0.75rem;">Received: Yesterday</div></div>
                <span style="color:#16a34a; background:#dcfce7; padding:2px 6px; border-radius:4px;">‚úÖ Delivered</span>
            </div>
            <div class="history-item">
                <div><strong>Truck #02 (${target.name})</strong><div style="font-size:0.75rem;">Received: Mon</div></div>
                <span style="color:#16a34a; background:#dcfce7; padding:2px 6px; border-radius:4px;">‚úÖ Delivered</span>
            </div>
        `;

        // Start App
        renderTrucks();

    </script>
</body>
</html>
