<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Citizen Portal | UrbanPulse</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    body {
      display: flex;
      height: 100vh;
      overflow: hidden;
      background: url('/static/background.jpg') no-repeat center center fixed;
      background-size: cover;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .sidebar {
      width: 380px;
      min-width: 380px;
      height: 100vh;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      padding: 30px;
      display: flex;
      flex-direction: column;
      box-shadow: 10px 0 30px rgba(0,0,0,0.1);
      z-index: 1000;
      overflow-y: auto;
    }
    .main-content {
      flex: 1;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
    }
    #map {
      width: 90%;
      height: 80%;
      border-radius: 25px;
      overflow: hidden;
      box-shadow: 0 20px 50px rgba(0,0,0,0.3);
      border: 5px solid white;
      background: #fff;
    }
    .widget {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 20px;
      border-left: 5px solid #667eea;
      color: #333;
    }
    #clock { font-size: 1.5rem; font-weight: bold; }
    .psi-badge {
      display: inline-block;
      padding: 10px 20px;
      border-radius: 50px;
      font-weight: bold;
      color: white;
      margin-top: 10px;
      text-transform: uppercase;
    }
    .small-note {
      margin-top: 10px;
      font-size: 0.82rem;
      color: #64748b;
      line-height: 1.3;
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      padding: 10px;
      border-radius: 10px;
    }
    .hint {
      font-size: 0.9rem;
      opacity: 0.8;
    }
  </style>
</head>

<body>
  <div class="sidebar">
    <a href="/" style="text-decoration: none; color: #667eea; font-weight: bold;">‚Üê Back to Home</a>
    <h1 style="color: #2c3e50; margin-top: 20px;">UrbanPulse</h1>

    <div class="widget">
      <div id="clock">00:00:00</div>
      <div id="date" style="font-size: 0.9rem; opacity: 0.7;"></div>
    </div>

    <div id="info-panel">
      <h3>üìç Live Monitoring</h3>
      <p class="hint">
        Tap a region marker to view PSI and the citizen health advisory generated by UrbanPulse agents.
      </p>
      <div class="small-note">
        <b>Automation proof:</b> When a haze scenario triggers, the advisory updates without manual calculation.
        The decision logic runs server-side (agent orchestration), not in the browser.
      </div>
    </div>
    <div class="section-spacer"></div>
    <!-- Scanning for IOT Devices -->
    <h3 style="color: #2c3e50; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between;">
      üîç IoT Devices
      <span id="reset-btn" style="font-size: 1.2rem; cursor: pointer; opacity: 0.6;" title="Reset Scan">üîÑ</span>
    </h3>
    <div class="iot-scanner">
      <div class="scanner-title" id="scanning-status">Scanning for IOT devices nearby...</div>
      <div id="scanning-loader" class="scanning-animation">
        <span class="dot"></span>
        <span class="dot"></span>
        <span class="dot"></span>
      </div>
      <div id="scan-timer" style="font-size: 0.8rem; margin-top: 8px; color: #667eea;">3s</div>
      <div id="devices-list" class="devices-container"></div>
    </div>

    <div style="margin-top: auto; font-size: 0.8rem; color: #7f8c8d;">
      Connected to Environment Sentinel<br />
      Data source: NEA / data.gov.sg (live + demo scenarios)
    </div>
  </div>

  <div class="main-content">
    <div id="map"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- IMPORTANT: this is your unified frontend controller -->
  <script src="/static/script.js"></script>

  <script>
    // 1) Map setup
    const singaporeBounds = L.latLngBounds(L.latLng(1.15, 103.55), L.latLng(1.50, 104.15));
    const map = L.map('map', {
      center: [1.3521, 103.8198],
      zoom: 12,
      minZoom: 11,
      maxZoom: 17,
      maxBounds: singaporeBounds,
      maxBoundsViscosity: 1.0
    });

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // Region marker set + scenarios
    const regions = [
      { id: "central", label: "Central (Toa Payoh/Bishan)", pos: [1.3483, 103.8493], scenario: "severe_haze", color: '#ef4444' },
      { id: "west", label: "West (Jurong East)", pos: [1.3329, 103.7436], scenario: "moderate_haze", color: '#f59e0b' },
      { id: "north", label: "North (Woodlands)", pos: [1.4361, 103.7865], scenario: "low_haze", color: '#10b981' },
      { id: "east", label: "East (Tampines)", pos: [1.3525, 103.9447], scenario: "moderate_haze", color: '#f59e0b' },
      { id: "south", label: "South (Harbourfront)", pos: [1.2653, 103.8210], scenario: "low_haze", color: '#10b981' }
    ];

    function getStatusColor(risk) {
      const r = String(risk || "").toUpperCase();
      if (r.includes('CRITICAL') || r.includes('SEVERE') || r.includes('UNHEALTHY')) return '#ef4444';
      if (r.includes('MODERATE')) return '#f59e0b';
      if (r.includes('LOW') || r.includes('GOOD')) return '#10b981';
      return '#667eea';
    }

    // markers by region id
    const regionMarkers = {};

     regions.forEach(region => {
      const marker = L.circleMarker(region.pos, {
        color: region.color || '#667eea', 
        fillColor: region.color || '#667eea',
        fillOpacity: 0.6,
        radius: 15
      }).addTo(map);

      // Store original color in marker
      marker.originalColor = region.color || '#667eea';

      regionMarkers[region.id] = marker;

      marker.on('click', () => refreshRegion(region, true));
      marker.bindPopup(`<b>${region.label}</b><br>Tap to load PSI...`);
      
    });

    // 2) Core refresh flow
    async function refreshRegion(region, updateSidebarFlag = false) {
      const marker = regionMarkers[region.id];
      try {
        // ‚úÖ This triggers your backend agent flow.
        // runRegionScenario is provided by /static/script.js
        const result = await window.runRegionScenario(region.scenario);

        // Robustly read PSI + risk from whatever the backend returns
        const risk = result.risk_assessment || result.risk || {};
        const raw = result.raw_data || result.data || {};

        const psiDict =
          (result.environmental_data?.psi_by_region) ||
          (raw.psi_data) ||
          (raw.psi) ||
          (result.psi_data) ||
          (result.psi) ||
          {};

        // psi could be dict (by region) or single number
        const currentPsi = (typeof psiDict === "object" && psiDict !== null)
          ? (psiDict[region.id] ?? psiDict[region.id.toUpperCase()] ?? psiDict[region.label] ?? risk.current_psi ?? "N/A")
          : (psiDict ?? "N/A");

        const riskLevel = risk.risk_level ?? result.risk_level ?? "N/A";

        // Update marker popup and style only when user explicitly clicks (updateSidebarFlag = true)
        // Keep region colors on initial load
        if (updateSidebarFlag) {
          marker.setStyle({ color: getStatusColor(riskLevel), fillColor: getStatusColor(riskLevel) });
        }
        marker.bindPopup(`<b>${region.label}</b><br>PSI: ${currentPsi}<br>Risk: ${riskLevel}`);

        if (updateSidebarFlag) {
          updateSidebar({
            name: region.label,
            psi: currentPsi,
            risk: String(riskLevel)
          }, result);

          marker.openPopup();
        }
      } catch (error) {
        console.error(`Error loading ${region.id}:`, error);
        if (updateSidebarFlag) {
          const panel = document.getElementById('info-panel');
          panel.innerHTML = `
            <h3>‚ö†Ô∏è Unable to fetch advisory</h3>
            <p style="color:#64748b;">${String(error.message || error)}</p>
            <div class="small-note">
              Tip: Ensure backend is running and the scenario endpoint is reachable.
            </div>
          `;
        }
      }
    }

    // 3) Sidebar UI
    function updateSidebar(data, fullResult) {
      const panel = document.getElementById('info-panel');
      const color = getStatusColor(data.risk);

      const isHazard = data.risk.toUpperCase().includes('CRITICAL') || data.risk.toUpperCase().includes('MODERATE') || data.risk.toUpperCase().includes('SEVERE');

      const advisoryText = isHazard
        ? `Haze activity detected. UrbanPulse agents recommend limiting outdoor exposure and preparing masks.`
        : `Air quality is stable. UrbanPulse agents continue background monitoring.`;

      const healthTipHtml = data.risk.toUpperCase().includes('CRITICAL') || data.risk.toUpperCase().includes('SEVERE')
        ? `<p style="background:#fee2e2;color:#991b1b;padding:10px;border-radius:8px;border-left:4px solid #ef4444;">
             <b>Health Tip:</b> Wear an N95 mask outdoors and avoid strenuous activity.
           </p>`
        : `<p style="background:#d1fae5;color:#065f46;padding:10px;border-radius:8px;border-left:4px solid #10b981;">
             <b>Health Tip:</b> Conditions are generally safe; stay hydrated and monitor updates.
           </p>`;

      // Optional: show "proof of automation" from response if present
      const hasLogs = Array.isArray(fullResult?.logs) && fullResult.logs.length > 0;
      const proofLine = hasLogs
        ? `<div class="small-note"><b>Agent log captured:</b> ${fullResult.logs.length} steps executed server-side.</div>`
        : `<div class="small-note"><b>Agent execution:</b> advisory generated by server-side orchestration (not a static message).</div>`;

      panel.innerHTML = `
        <h2 style="color:${color}; margin-bottom: 8px;">${data.name}</h2>
        <div style="display: flex; align-items: center; justify-content: space-between; gap: 10px;">
          <div class="psi-badge" style="background:${color}">${data.risk} (PSI: ${data.psi})</div>
          <button onclick="resetSidebarView()"
            class="psi-badge"
            style="background:${color}; color:white; border:none;
            padding:10px 20px; border-radius:50px;
            cursor:pointer; font-weight:bold;"> Back </button>
          </div>
        <hr style="margin: 18px 0; border: 0; border-top: 1px solid #eee;">
        <h4 style="margin: 0 0 8px 0;">ü§ñ Agent Advisory</h4>
        <p style="margin-top:0;">${advisoryText}</p>
        ${healthTipHtml}
        ${proofLine}
      `;
    }

    // Reset sidebar to original state
    function resetSidebarView() {
      const panel = document.getElementById('info-panel');
      panel.innerHTML = `
        <h3>üìç Live Monitoring</h3>
        <p class="hint">
          Tap a region marker to view PSI and the citizen health advisory generated by UrbanPulse agents.
        </p>
        <div class="small-note">
          <b>Automation proof:</b> When a haze scenario triggers, the advisory updates without manual calculation.
          The decision logic runs server-side (agent orchestration), not in the browser.
        </div>
      `;
      // Restore original colors to all markers
      Object.values(regionMarkers).forEach(marker => {
        if (marker.originalColor) {
          marker.setStyle({ color: marker.originalColor, fillColor: marker.originalColor });
        }
      });
    }

    // 4) Clock
    function updateClock() {
      const now = new Date();
      document.getElementById('clock').innerText = now.toLocaleTimeString();
      document.getElementById('date').innerText = now.toDateString();
    }
    setInterval(updateClock, 1000);
    updateClock();

    // 5) Initial boot-up: auto-color everything
    async function initDashboard() {
      for (const region of regions) {
        await refreshRegion(region, false);
      }
    }
    function updateClock() {
      const now = new Date();
      document.getElementById('clock').innerText = now.toLocaleTimeString();
      document.getElementById('date').innerText = now.toDateString();
    }
    setInterval(updateClock, 1000);
    updateClock();

    // IoT Device Scanner ‚Äî air-purifying devices
    const smartDevices = [
      { icon: 'üå¨Ô∏è', name: 'Air Purifier', on: true },
      { icon: '‚ùÑÔ∏è', name: 'Air Conditioner', on: false },
      { icon: 'üåÄ', name: 'Exhaust Fan', on: false },
      { icon: 'ü™ü', name: 'Smart Vent', on: false },
    ];

    function randomizeDevices() {
      // Randomize on/off state for each device so scan results vary
      smartDevices.forEach(device => {
        // heavier devices slightly less likely to be ON
        const heavy = ['Washing Machine', 'Coffee Maker', 'Smart TV'];
        const prob = heavy.includes(device.name) ? 0.35 : 0.6;
        device.on = Math.random() < prob;
        // assign a random timer (1-8 hours) for display
        device.timerHours = Math.floor(Math.random() * 8) + 1;
        // clear any scheduled overrides when randomizing
        device.scheduledUntil = null;
      });
      console.log('randomizeDevices ->', smartDevices.map(d => ({ name: d.name, on: d.on, timerHours: d.timerHours })));
    }

    function toggleDevice(index) {
      smartDevices[index].on = !smartDevices[index].on;
      // manual toggle clears any scheduled override
      smartDevices[index].scheduledUntil = null;
      renderDevices();
    }

    function renderDevices() {
      const devicesEl = document.getElementById('devices-list');
      devicesEl.innerHTML = '';
      smartDevices.forEach((device, index) => {
        const card = document.createElement('div');
        card.className = 'device-card';
        const btnClass = device.on ? 'toggle-btn on' : 'toggle-btn off';
        const btnText = device.on ? 'ON' : 'OFF';
        const status = device.on ? 'Active' : 'Inactive';
        const statusColor = device.on ? '#10b981' : '#ef4444';
        // compute remaining time if a scheduledUntil exists
        let remainingText = '';
        if (device.scheduledUntil) {
          const remMs = device.scheduledUntil - Date.now();
          if (remMs > 0) remainingText = ` ‚Äî ${formatRemaining(remMs)} left`;
          else {
            // expired
            device.scheduledUntil = null;
          }
        }
        const timerHours = device.timerHours || '-';
        card.innerHTML = `
          <div class="device-info">
            <div class="device-icon">${device.icon}</div>
            <div class="device-details">
              <div class="device-name">${device.name}</div>
              <div class="device-status" style="color: ${statusColor};">${status}</div>
              <div class="device-timer">Timer: ${timerHours}h${remainingText}</div>
            </div>
          </div>
          <button class="${btnClass}" onclick="toggleDevice(${index})">${btnText}</button>
        `;
        devicesEl.appendChild(card);
      });
    }

    function formatRemaining(ms) {
      if (!ms || ms <= 0) return '0m';
      const totalMin = Math.ceil(ms / 60000);
      const h = Math.floor(totalMin / 60);
      const m = totalMin % 60;
      if (h > 0) return `${h}h ${m}m`;
      return `${m}m`;
    }

    function startIoTScan() {
      let scanTime = 3;
      const timerEl = document.getElementById('scan-timer');
      const scannerEl = document.getElementById('scanning-loader');
      const devicesEl = document.getElementById('devices-list');
      const statusEl = document.getElementById('scanning-status');

      const scanInterval = setInterval(() => {
        scanTime--;
        timerEl.innerText = scanTime + 's';

        if (scanTime <= 0) {
          clearInterval(scanInterval);
          scannerEl.style.display = 'none';
          timerEl.innerText = '‚úì Complete';
          // determine condition and display
          const condition = determineHazeCondition();
          const color = condition === 'Low' ? '#10b981' : (condition === 'Moderate' ? '#f59e0b' : '#ef4444');
          statusEl.innerHTML = `<b>Haze Condition:</b> <span style="color:${color};">${condition}</span>`;
          devicesEl.classList.add('show');
          renderDevices();
          console.log('IoT scan complete, condition:', condition, 'recommendations:', getRecommendations(condition));
          if (condition === 'Moderate' || condition === 'Severe') showRecommendationModal(condition);
        }
      }, 1000);
    }

    function resetScan() {
      const timerEl = document.getElementById('scan-timer');
      const scannerEl = document.getElementById('scanning-loader');
      const devicesEl = document.getElementById('devices-list');
      const statusEl = document.getElementById('scanning-status');
      
      devicesEl.classList.remove('show');
      devicesEl.innerHTML = '';
      scannerEl.style.display = 'inline-block';
      timerEl.innerText = '3s';
      timerEl.style.color = '#667eea';
      statusEl.textContent = 'Scanning for IOT devices nearby you...';
      // Randomize device states so recommendations differ each scan
      randomizeDevices();
      startIoTScan();
    }

    function determineHazeCondition() {
      const r = Math.random();
      if (r < 0.6) return 'Low';
      if (r < 0.9) return 'Moderate';
      return 'Severe';
    }

    function getRecommendations(condition) {
      // For Moderate/Severe haze, recommend turning ON purifying devices that are currently OFF
      const recommendations = [];
      if (condition !== 'Moderate' && condition !== 'Severe') return recommendations;
      smartDevices.forEach((device, index) => {
        if (!device.on) {
          recommendations.push({ name: device.name, index: index });
        }
      });
      return recommendations;
    }

    function showRecommendationModal(condition) {
      const recommendations = getRecommendations(condition);
      console.log('showRecommendationModal -> recommendations:', recommendations, 'condition:', condition);
      if (recommendations.length === 0) return; // No recommendations needed

      const modal = document.getElementById('recommendation-modal');
      const itemsContainer = document.getElementById('recommendation-items');
      if (!modal || !itemsContainer) {
        console.warn('Recommendation modal elements not found');
        return;
      }
      itemsContainer.innerHTML = '';

      recommendations.forEach(rec => {
        const item = document.createElement('div');
        item.className = 'recommendation-item';
        item.innerHTML = `‚úì ${rec.name}`;
        itemsContainer.appendChild(item);
      });

      // show duration suggestion
      const durationEl = document.getElementById('recommendation-duration');
      if (durationEl) {
        if (condition === 'Severe') durationEl.innerText = 'Recommended runtime: 4 hours';
        else if (condition === 'Moderate') durationEl.innerText = 'Recommended runtime: 2 hours';
        else durationEl.innerText = '';
      }

      // auto-apply recommendations immediately to make it seem automatic
      const hours = condition === 'Severe' ? 4 : 2;
      const until = Date.now() + hours * 60 * 60 * 1000;
      const applied = [];
      recommendations.forEach(rec => {
        const dev = smartDevices[rec.index];
        applied.push({ index: rec.index, prevOn: dev.on, prevTimerHours: dev.timerHours || null, prevScheduledUntil: dev.scheduledUntil || null });
        dev.on = true;
        dev.scheduledUntil = until;
        dev.timerHours = hours; // show the recommended runtime
      });
      // store applied data so user can undo
      modal.dataset.applied = JSON.stringify(applied);
      modal.dataset.recommendations = JSON.stringify(recommendations);
      modal.dataset.condition = condition;
      // update header to reflect automatic action
      const headerEl = document.getElementById('recommendation-header');
      if (headerEl) {
        const names = recommendations.map(r => r.name).join(', ');
        headerEl.innerText = `Turning on: ${names} for ${hours} hours.`;
      }
      renderDevices();
      modal.classList.add('show');
    }

    // dismiss (just close the modal)
    function dismissRecommendation() {
      const modal = document.getElementById('recommendation-modal');
      if (modal) modal.classList.remove('show');
    }


    document.getElementById('reset-btn').addEventListener('click', resetScan);

    // Start the auto-load process
    initDashboard();
    // Randomize devices and start IoT scan on page load
    randomizeDevices();
    startIoTScan();
  </script>

    <!-- Recommendation Modal (moved to root for visibility) -->
  <div id="recommendation-modal" class="modal-overlay">
    <div class="modal-dialog">
      <div class="modal-title">ü´ß Air Purification in progress...</div>
      <div class="recommendation-list">
        <div id="recommendation-header" style="font-weight: bold; margin-bottom: 10px; color: #667eea;">It is recommended to turn on:</div>
        <div id="recommendation-duration" style="font-size:0.9rem; margin-bottom:8px; color: #374151;"></div>
        <div id="recommendation-items"></div>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn accept" onclick="dismissRecommendation()">Close</button>
      </div>
    </div>
  </div>

  <!-- ‚úÖ Watson Assistant web chat removed (prevents ‚ÄúConnect to agent‚Äù error) -->
</body>
</html>
