<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Citizen Portal | UrbanPulse</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    body {
      display: flex;
      height: 100vh;
      overflow: hidden;
      background: url('/static/background.jpg') no-repeat center center fixed;
      background-size: cover;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .sidebar {
      width: 380px;
      min-width: 380px;
      height: 100vh;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      padding: 30px;
      display: flex;
      flex-direction: column;
      box-shadow: 10px 0 30px rgba(0,0,0,0.1);
      z-index: 1000;
    }
    .main-content {
      flex: 1;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
    }
    #map {
      width: 90%;
      height: 80%;
      border-radius: 25px;
      overflow: hidden;
      box-shadow: 0 20px 50px rgba(0,0,0,0.3);
      border: 5px solid white;
      background: #fff;
    }
    .widget {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 20px;
      border-left: 5px solid #667eea;
      color: #333;
    }
    #clock { font-size: 1.5rem; font-weight: bold; }
    .psi-badge {
      display: inline-block;
      padding: 10px 20px;
      border-radius: 50px;
      font-weight: bold;
      color: white;
      margin-top: 10px;
      text-transform: uppercase;
    }
    .small-note {
      margin-top: 10px;
      font-size: 0.82rem;
      color: #64748b;
      line-height: 1.3;
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      padding: 10px;
      border-radius: 10px;
    }
    .hint {
      font-size: 0.9rem;
      opacity: 0.8;
    }
  </style>
</head>

<body>
  <div class="sidebar">
    <a href="/" style="text-decoration: none; color: #667eea; font-weight: bold;">‚Üê Back to Home</a>
    <h1 style="color: #2c3e50; margin-top: 20px;">UrbanPulse</h1>

    <div class="widget">
      <div id="clock">00:00:00</div>
      <div id="date" style="font-size: 0.9rem; opacity: 0.7;"></div>
    </div>

    <div id="info-panel">
      <h3>üìç Live Monitoring</h3>
      <p class="hint">
        Tap a region marker to view PSI and the citizen health advisory generated by UrbanPulse agents.
      </p>
      <div class="small-note">
        <b>Automation proof:</b> When a haze scenario triggers, the advisory updates without manual calculation.
        The decision logic runs server-side (agent orchestration), not in the browser.
      </div>
    </div>

    <div style="margin-top: auto; font-size: 0.8rem; color: #7f8c8d;">
      Connected to Environment Sentinel<br />
      Data source: NEA / data.gov.sg (live + demo scenarios)
    </div>
  </div>

  <div class="main-content">
    <div id="map"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- IMPORTANT: this is your unified frontend controller -->
  <script src="/static/script.js"></script>

  <script>
    // 1) Map setup
    const singaporeBounds = L.latLngBounds(L.latLng(1.15, 103.55), L.latLng(1.50, 104.15));
    const map = L.map('map', {
      center: [1.3521, 103.8198],
      zoom: 12,
      minZoom: 11,
      maxZoom: 17,
      maxBounds: singaporeBounds,
      maxBoundsViscosity: 1.0
    });

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // Region marker set + scenarios
    const regions = [
      { id: "central", label: "Central (Toa Payoh/Bishan)", pos: [1.3483, 103.8493], scenario: "severe_haze" },
      { id: "west",    label: "West (Jurong East)",        pos: [1.3329, 103.7436], scenario: "moderate_haze" },
      { id: "north",   label: "North (Woodlands)",         pos: [1.4361, 103.7865], scenario: "low_haze" },
      { id: "east",    label: "East (Tampines)",           pos: [1.3525, 103.9447], scenario: "moderate_haze" },
      { id: "south",   label: "South (Harbourfront)",      pos: [1.2653, 103.8210], scenario: "low_haze" }
    ];

    function getStatusColor(risk) {
      const r = String(risk || "").toUpperCase();
      if (r.includes('CRITICAL') || r.includes('SEVERE') || r.includes('UNHEALTHY')) return '#ef4444';
      if (r.includes('MODERATE')) return '#f59e0b';
      if (r.includes('LOW') || r.includes('GOOD')) return '#10b981';
      return '#667eea';
    }

    // markers by region id
    const regionMarkers = {};

    regions.forEach(region => {
      const marker = L.circleMarker(region.pos, {
        color: '#667eea',
        fillColor: '#667eea',
        fillOpacity: 0.5,
        radius: 15
      }).addTo(map);

      regionMarkers[region.id] = marker;

      marker.on('click', () => refreshRegion(region, true));
      marker.bindPopup(`<b>${region.label}</b><br>Tap to load PSI...`);
    });

    // 2) Core refresh flow
    async function refreshRegion(region, updateSidebarFlag = false) {
      const marker = regionMarkers[region.id];
      try {
        // ‚úÖ This triggers your backend agent flow.
        // runRegionScenario is provided by /static/script.js
        const result = await window.runRegionScenario(region.scenario);

        // Robustly read PSI + risk from whatever the backend returns
        const risk = result.risk_assessment || result.risk || {};
        const raw = result.raw_data || result.data || {};

        const psiDict =
          (raw.psi_data) ||
          (raw.psi) ||
          (result.psi_data) ||
          (result.psi) ||
          {};

        // psi could be dict (by region) or single number
        const currentPsi = (typeof psiDict === "object" && psiDict !== null)
          ? (psiDict[region.id] ?? psiDict[region.id.toUpperCase()] ?? psiDict[region.label] ?? "N/A")
          : (psiDict ?? "N/A");

        const riskLevel = risk.risk_level ?? result.risk_level ?? "N/A";

        // Update marker popup + style
        marker.setStyle({ color: getStatusColor(riskLevel), fillColor: getStatusColor(riskLevel) });
        marker.bindPopup(`<b>${region.label}</b><br>PSI: ${currentPsi}<br>Risk: ${riskLevel}`);

        if (updateSidebarFlag) {
          updateSidebar({
            name: region.label,
            psi: currentPsi,
            risk: String(riskLevel)
          }, result);

          marker.openPopup();
        }
      } catch (error) {
        console.error(`Error loading ${region.id}:`, error);
        if (updateSidebarFlag) {
          const panel = document.getElementById('info-panel');
          panel.innerHTML = `
            <h3>‚ö†Ô∏è Unable to fetch advisory</h3>
            <p style="color:#64748b;">${String(error.message || error)}</p>
            <div class="small-note">
              Tip: Ensure backend is running and the scenario endpoint is reachable.
            </div>
          `;
        }
      }
    }

    // 3) Sidebar UI
    function updateSidebar(data, fullResult) {
      const panel = document.getElementById('info-panel');
      const color = getStatusColor(data.risk);

      const isHazard = data.risk.toUpperCase().includes('CRITICAL') || data.risk.toUpperCase().includes('MODERATE') || data.risk.toUpperCase().includes('SEVERE');

      const advisoryText = isHazard
        ? `Haze activity detected. UrbanPulse agents recommend limiting outdoor exposure and preparing masks.`
        : `Air quality is stable. UrbanPulse agents continue background monitoring.`;

      const healthTipHtml = data.risk.toUpperCase().includes('CRITICAL') || data.risk.toUpperCase().includes('SEVERE')
        ? `<p style="background:#fee2e2;color:#991b1b;padding:10px;border-radius:8px;border-left:4px solid #ef4444;">
             <b>Health Tip:</b> Wear an N95 mask outdoors and avoid strenuous activity.
           </p>`
        : `<p style="background:#d1fae5;color:#065f46;padding:10px;border-radius:8px;border-left:4px solid #10b981;">
             <b>Health Tip:</b> Conditions are generally safe; stay hydrated and monitor updates.
           </p>`;

      // Optional: show "proof of automation" from response if present
      const hasLogs = Array.isArray(fullResult?.logs) && fullResult.logs.length > 0;
      const proofLine = hasLogs
        ? `<div class="small-note"><b>Agent log captured:</b> ${fullResult.logs.length} steps executed server-side.</div>`
        : `<div class="small-note"><b>Agent execution:</b> advisory generated by server-side orchestration (not a static message).</div>`;

      panel.innerHTML = `
        <h2 style="color:${color}; margin-bottom: 8px;">${data.name}</h2>
        <div class="psi-badge" style="background:${color}">${data.risk} (PSI: ${data.psi})</div>
        <hr style="margin: 18px 0; border: 0; border-top: 1px solid #eee;">
        <h4 style="margin: 0 0 8px 0;">ü§ñ Agent Advisory</h4>
        <p style="margin-top:0;">${advisoryText}</p>
        ${healthTipHtml}
        ${proofLine}
      `;
    }

    // 4) Clock
    function updateClock() {
      const now = new Date();
      document.getElementById('clock').innerText = now.toLocaleTimeString();
      document.getElementById('date').innerText = now.toDateString();
    }
    setInterval(updateClock, 1000);
    updateClock();

    // 5) Initial boot-up: auto-color everything
    async function initDashboard() {
      for (const region of regions) {
        await refreshRegion(region, false);
      }
    }
    initDashboard();
  </script>

  <!-- ‚úÖ Watson Assistant web chat removed (prevents ‚ÄúConnect to agent‚Äù error) -->
</body>
</html>
